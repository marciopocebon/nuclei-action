name: "Nuclei Scanning - Action"
description: ""

inputs:
  urls-txt:
    description: "List of urls to run templates"
    required: true
  slack-token:
    description: "Slack token"
    required: true
  slack-channel:
    description: "Slack channel"
    required: true
  dd-api-key:
    description: "DataDog API Key"
    required: true

runs:
  using: "composite"

  steps:
    - run: GO111MODULE=on go get -u -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei
      shell: bash

    - run: |
        $HOME/go/bin/nuclei -l $GITHUB_WORKSPACE/${{ inputs.urls-txt }} \
          -json \
          -update-directory . \
          -update-templates \
          -t nuclei-templates/cves/ \
          -t nuclei-templates/files/ \
          -t nuclei-templates/security-misconfiguration/ \
          -t nuclei-templates/subdomain-takeover/ \
          -t nuclei-templates/vulnerabilities/ \
          -o output.txt
      shell: bash

    - run: |
        git clone https://github.com/aqme/appsec-etl.git
        pip3 install setuptools --upgrade

        if [ ${{ inputs.slack-token }} ]
        then
          pip3 install slackclient --upgrade
          cat output.txt | python3 appsec-etl/transform/nuclei/toslack.py | python3 appsec-etl/load/slack.py ${{ inputs.slack-token }} ${{ inputs.slack-channel }}
        fi

        if [ ${{ inputs.dd-api-key }} ]
        then
          pip3 install requests
          cat output.txt | python3 appsec-etl/transform/nuclei/todatadog.py | python3 appsec-etl/load/datadog.py ${{ inputs.dd-api-key }}
        fi
      shell: bash
